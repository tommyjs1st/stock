        
        // ğŸ”¥ ì‹œì¥ ìƒíƒœì— ë”°ë¥¸ ìë™ ìƒˆë¡œê³ ì¹¨ ê°„ê²© ì¡°ì •
        async function getOptimalRefreshInterval() {
            try {
                const response = await fetch('/api/system-status');
                const status = await response.json();
                
                if (status.is_market_hours) {
                    return 30000; // ì¥ì¤‘: 30ì´ˆë§ˆë‹¤ í™”ë©´ ìƒˆë¡œê³ ì¹¨
                } else {
                    return 300000; // ì¥ì™¸: 5ë¶„ë§ˆë‹¤ í™”ë©´ ìƒˆë¡œê³ ì¹¨
                }
            } catch (error) {
                console.error('ì‹œìŠ¤í…œ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:', error);
                return 60000; // ê¸°ë³¸ê°’: 1ë¶„
            }
        }
        
        // ğŸ”¥ ìµœì í™”ëœ ìë™ ìƒˆë¡œê³ ì¹¨
        async function startOptimizedAutoRefresh() {
            if (isAutoRefresh) return;
            
            isAutoRefresh = true;
            document.getElementById('autoRefreshText').textContent = 'ìë™ìƒˆë¡œê³ ì¹¨ ì¤‘ì§€';
            
            const refreshFunction = async () => {
                try {
                    // ë„ˆë¬´ ë¹ˆë²ˆí•œ ìš”ì²­ ë°©ì§€ (ìµœì†Œ 10ì´ˆ ê°„ê²©)
                    const now = Date.now();
                    if (now - lastRefreshTime < 10000) {
                        console.log('â° ìƒˆë¡œê³ ì¹¨ ì¿¨ë‹¤ìš´ ì¤‘...');
                        return;
                    }
                    
                    await refreshData();
                    lastRefreshTime = now;
                    
                    // ì‹œì¥ ìƒíƒœì— ë”°ë¼ ë‹¤ìŒ ìƒˆë¡œê³ ì¹¨ ê°„ê²© ì¡°ì •
                    if (isAutoRefresh) {
                        const interval = await getOptimalRefreshInterval();
                        console.log(`ğŸ”„ ë‹¤ìŒ ìë™ ìƒˆë¡œê³ ì¹¨: ${interval/1000}ì´ˆ í›„`);
                        
                        clearTimeout(autoRefreshInterval);
                        autoRefreshInterval = setTimeout(refreshFunction, interval);
                    }
                    
                } catch (error) {
                    console.error('ìë™ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
                    
                    // ì˜¤ë¥˜ ì‹œ ë” ê¸´ ê°„ê²©ìœ¼ë¡œ ì¬ì‹œë„
                    if (isAutoRefresh) {
                        autoRefreshInterval = setTimeout(refreshFunction, 60000);
                    }
                }
            };
            
            // ì¦‰ì‹œ ì²« ë²ˆì§¸ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰
            refreshFunction();
        }
        
        function stopAutoRefresh() {
            isAutoRefresh = false;
            if (autoRefreshInterval) {
                clearTimeout(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            document.getElementById('autoRefreshText').textContent = 'ìë™ìƒˆë¡œê³ ì¹¨ ì‹œì‘';
        }
        
        function toggleAutoRefresh() {
            if (isAutoRefresh) {
                stopAutoRefresh();
            } else {
                startOptimizedAutoRefresh();
            }
        }
        
        // ğŸ”¥ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨ë„ ì¿¨ë‹¤ìš´ ì ìš©
        async function refreshData() {
            const refreshBtn = document.querySelector('.refresh-btn');
            const refreshText = document.getElementById('refreshText');
            
            // ì¿¨ë‹¤ìš´ ì²´í¬
            const now = Date.now();
            if (now - lastRefreshTime < 10000 && lastRefreshTime > 0) {
                const remaining = Math.ceil((10000 - (now - lastRefreshTime)) / 1000);
                refreshText.textContent = `${remaining}ì´ˆ í›„ ê°€ëŠ¥`;
                setTimeout(() => {
                    refreshText.textContent = 'ìƒˆë¡œê³ ì¹¨';
                }, remaining * 1000);
                return;
            }
            
            refreshBtn.disabled = true;
            refreshText.innerHTML = '<div class="loading"></div> ë¡œë”©ì¤‘...';
        
            try {
                const data = await fetchPortfolioData();
                renderPortfolio(data);
                updateTimestamp();
                updateMarketStatus();
                
                // ì„œë²„ ì‹œê°„ ì—…ë°ì´íŠ¸
                if (data.lastUpdate) {
                    const serverTime = new Date(data.lastUpdate);
                    const timeString = serverTime.toLocaleString('ko-KR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    document.getElementById('lastUpdate').textContent = `ìµœì¢… ì—…ë°ì´íŠ¸: ${timeString}`;
                }
        
                // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                await renderCompleteDailyReturnChart();
                
                lastRefreshTime = now;
                
            } catch (error) {
                console.error('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
                document.getElementById('portfolioContainer').innerHTML = 
                    `<div class="error-message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
            } finally {
                refreshBtn.disabled = false;
                refreshText.textContent = 'ìƒˆë¡œê³ ì¹¨';
            }
        }
