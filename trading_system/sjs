    def process_sell_for_symbol(self, symbol: str, position: dict):
        """개선된 매도 처리 - 추세를 고려한 손절/익절"""
        try:
            if symbol not in self.all_positions:
                return
                
            quantity = position['quantity']
            profit_loss_pct = position['profit_loss']
            profit_loss_decimal = profit_loss_pct / 100
            stock_name = self.get_stock_name(symbol)
            current_price = position['current_price']
            
            # 🆕 일봉 추세 분석 먼저 수행 (모든 판단의 기준)
            daily_analysis = self.hybrid_strategy.analyze_daily_strategy(symbol)
            
            # 🔥 1순위: 극단적 손실 (-10% 이상) - 무조건 손절 (기준 강화)
            if profit_loss_decimal <= -0.10:
                self.logger.warning(f"🛑 {stock_name}({symbol}) 극한 손절! ({profit_loss_pct:+.2f}%)")
                self.execute_sell(symbol, quantity, "urgent", "극한손절")
                return
            
            # 🔥 2순위: 중간 손실 (-7% ~ -10%) - 추세 확인 후 결정
            if -0.10 < profit_loss_decimal <= -0.07:
                # 강한 매수 신호면 보유
                if daily_analysis['signal'] == 'BUY' and daily_analysis['strength'] >= 4.0:
                    self.logger.warning(f"⚠️ {stock_name}({symbol}) 손실이지만 강한 상승신호로 보유: "
                                       f"{profit_loss_pct:+.2f}%, 신호 {daily_analysis['strength']:.1f}점")
                    return
                else:
                    # 추세 약하면 손절
                    self.logger.warning(f"🛑 {stock_name}({symbol}) 추세 약화로 손절! ({profit_loss_pct:+.2f}%)")
                    self.execute_sell(symbol, quantity, "urgent", "추세손절")
                    return
            
            # 🔥 3순위: 단계적 익절 (추세 고려)
            if profit_loss_decimal >= 0.20:  # 20% 이상 → 무조건 일부 익절
                # 전체 수량의 50% 익절
                partial_quantity = max(1, quantity // 2)
                self.logger.info(f"🎯 {stock_name}({symbol}) 1차 부분익절! "
                               f"{partial_quantity}/{quantity}주 ({profit_loss_pct:+.2f}%)")
                self.execute_sell(symbol, partial_quantity, "aggressive_limit", "1차부분익절")
                return
                
            elif profit_loss_decimal >= 0.15:  # 15~20% → 추세 확인
                # 매도 신호가 강하면 전량 익절
                if daily_analysis['signal'] == 'SELL' and daily_analysis['strength'] >= 3.0:
                    self.logger.info(f"🎯 {stock_name}({symbol}) 추세전환 전량익절! ({profit_loss_pct:+.2f}%)")
                    self.execute_sell(symbol, quantity, "aggressive_limit", "추세익절")
                    return
                # 상승 추세면 보유
                elif daily_analysis['signal'] == 'BUY' and daily_analysis['strength'] >= 3.0:
                    self.logger.info(f"📈 {stock_name}({symbol}) 상승 지속으로 보유: "
                                   f"{profit_loss_pct:+.2f}%, 신호 {daily_analysis['strength']:.1f}점")
                    return
                # 중립이면 익절
                else:
                    self.logger.info(f"🎯 {stock_name}({symbol}) 기술적 익절! ({profit_loss_pct:+.2f}%)")
                    self.execute_sell(symbol, quantity, "aggressive_limit", "기술적익절")
                    return
                    
            elif profit_loss_decimal >= 0.10:  # 10~15% → 매도 신호시만 익절
                if daily_analysis['signal'] == 'SELL' and daily_analysis['strength'] >= 2.5:
                    self.logger.info(f"🎯 {stock_name}({symbol}) 조기익절! ({profit_loss_pct:+.2f}%)")
                    self.execute_sell(symbol, quantity, "aggressive_limit", "조기익절")
                    return
