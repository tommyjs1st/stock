    """
    ì§€ëŠ¥í˜• ì†ì ˆ ì‹œìŠ¤í…œ - ìƒìŠ¹ ê°€ëŠ¥ì„±ì„ ê³ ë ¤í•œ ì†ì ˆ íŒë‹¨
    """
    
    def process_sell_for_symbol(self, symbol: str, position: dict):
        """ì§€ëŠ¥í˜• ê°œë³„ ì¢…ëª© ë§¤ë„ ì²˜ë¦¬ - ìƒìŠ¹ ê°€ëŠ¥ì„± ê³ ë ¤"""
        try:
            if symbol not in self.all_positions:
                return
                
            quantity = position['quantity']
            profit_loss_pct = position['profit_loss']
            profit_loss_decimal = profit_loss_pct / 100
            stock_name = self.get_stock_name(symbol)
            current_price = position['current_price']
            
            # ğŸ”¥ 1ìˆœìœ„: ê·¹ë‹¨ì  ì†ì‹¤ ë°©ì§€ (-7% ì´ìƒ ì†ì‹¤ì‹œ ë¬´ì¡°ê±´ ì†ì ˆ)
            if profit_loss_decimal <= -0.07:
                self.logger.warning(f"ğŸ›‘ {stock_name}({symbol}) ê·¹í•œ ì†ì ˆ! ({profit_loss_pct:+.2f}%)")
                self.execute_sell(symbol, quantity, "urgent", "ê·¹í•œì†ì ˆ")
                return
            
            # ğŸ”¥ 2ìˆœìœ„: ì§€ëŠ¥í˜• ì†ì ˆ íŒë‹¨ (-3% ~ -7% êµ¬ê°„ì—ì„œ ìƒìŠ¹ ê°€ëŠ¥ì„± ê²€í† )
            if -0.07 < profit_loss_decimal <= -0.03:
                recovery_analysis = self.analyze_recovery_potential(symbol, current_price)
                
                if recovery_analysis['should_hold']:
                    self.logger.info(f"ğŸ’ {stock_name}({symbol}) ì†ì ˆ ë³´ë¥˜: {recovery_analysis['reason']} "
                                   f"(í˜„ì¬: {profit_loss_pct:+.2f}%)")
                    return  # ì†ì ˆí•˜ì§€ ì•Šê³  ë³´ìœ  ì§€ì†
                else:
                    self.logger.warning(f"ğŸ›‘ {stock_name}({symbol}) ì§€ëŠ¥í˜• ì†ì ˆ: {recovery_analysis['reason']} "
                                      f"({profit_loss_pct:+.2f}%)")
                    self.execute_sell(symbol, quantity, "aggressive_limit", "ì§€ëŠ¥í˜•ì†ì ˆ")
                    return
            
            # ğŸ”¥ 3ìˆœìœ„: ê¸‰ë½ ê°ì§€ (í•˜ì§€ë§Œ íšŒë³µ ê°€ëŠ¥ì„±ë„ ì²´í¬)
            rapid_drop = self.check_rapid_drop(symbol, current_price)
            if rapid_drop['should_sell']:
                # ê¸‰ë½ ìƒí™©ì—ì„œë„ íšŒë³µ ê°€ëŠ¥ì„± ì²´í¬
                recovery_analysis = self.analyze_recovery_potential(symbol, current_price)
                
                if recovery_analysis['strong_recovery_signal']:
                    self.logger.info(f"ğŸ”„ {stock_name}({symbol}) ê¸‰ë½ì´ì§€ë§Œ íšŒë³µ ì‹ í˜¸ë¡œ ë³´ìœ : {recovery_analysis['reason']}")
                    return
                else:
                    self.logger.warning(f"ğŸ’¥ {stock_name}({symbol}) ê¸‰ë½ ë§¤ë„: {rapid_drop['reason']}")
                    self.execute_sell(symbol, quantity, "urgent", rapid_drop['reason'])
                    return
            
            # ë‚˜ë¨¸ì§€ ë¡œì§ì€ ê¸°ì¡´ê³¼ ë™ì¼ (ìµì ˆ, ê¸°ìˆ ì  ë§¤ë„ ë“±)
            if profit_loss_decimal >= 0.20:
                can_sell, sell_reason = self.position_manager.can_sell_symbol(symbol, quantity)
                if can_sell:
                    self.logger.info(f"ğŸ¯ {stock_name}({symbol}) ìµì ˆ ì‹¤í–‰! ({profit_loss_pct:+.2f}%)")
                    self.execute_sell(symbol, quantity, "aggressive_limit", "ìµì ˆë§¤")
                    return
            
            if symbol in self.symbols:
                daily_analysis = self.hybrid_strategy.analyze_daily_strategy(symbol)
                
                if daily_analysis['signal'] == 'SELL' and daily_analysis['strength'] >= 3.5:
                    can_sell, sell_reason = self.position_manager.can_sell_symbol(symbol, quantity)
                    
                    if can_sell:
                        self.logger.info(f"ğŸ“‰ {stock_name}({symbol}) ê¸°ìˆ ì  ë§¤ë„ ì‹ í˜¸")
                        self.execute_sell(symbol, quantity, "aggressive_limit", "ê¸°ìˆ ì ë§¤ë„")
                        return
                
        except Exception as e:
            self.logger.error(f"{symbol} ë§¤ë„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")
    
    
    def analyze_recovery_potential(self, symbol: str, current_price: float) -> Dict:
        """ìƒìŠ¹ íšŒë³µ ê°€ëŠ¥ì„± ë¶„ì„ - ìƒˆë¡œìš´ ë©”ì„œë“œ"""
        try:
            stock_name = self.get_stock_name(symbol)
            self.logger.info(f"ğŸ” {stock_name}({symbol}) íšŒë³µ ê°€ëŠ¥ì„± ë¶„ì„ ì‹œì‘")
            
            recovery_score = 0
            reasons = []
            
            # 1. ì¼ë´‰ ê¸°ìˆ ì  ë¶„ì„ (ê°€ì¥ ì¤‘ìš”)
            daily_analysis = self.hybrid_strategy.analyze_daily_strategy(symbol)
            
            if daily_analysis['signal'] == 'BUY':
                recovery_score += daily_analysis['strength']
                reasons.append(f"ì¼ë´‰ë§¤ìˆ˜ì‹ í˜¸({daily_analysis['strength']:.1f}ì )")
            
            # 2. ê°€ê²© ìœ„ì¹˜ ë¶„ì„
            daily_df = self.api_client.get_daily_data(symbol, days=60)
            if not daily_df.empty and len(daily_df) >= 20:
                # 20ì¼ í‰ê· ì„  ëŒ€ë¹„ ìœ„ì¹˜
                ma20 = daily_df['stck_prpr'].rolling(20).mean().iloc[-1]
                ma20_ratio = current_price / ma20
                
                if ma20_ratio <= 0.95:  # í‰ê· ì„  5% ì•„ë˜
                    recovery_score += 2.0
                    reasons.append(f"í‰ê· ì„ í•˜íšŒ({ma20_ratio:.3f})")
                
                # 60ì¼ ê³ ì  ëŒ€ë¹„ ìœ„ì¹˜
                high_60 = daily_df['stck_prpr'].rolling(60).max().iloc[-1]
                price_position = current_price / high_60
                
                if price_position <= 0.7:  # ê³ ì  ëŒ€ë¹„ 30% ì´ìƒ í•˜ë½
                    recovery_score += 1.5
                    reasons.append(f"ê³ ì ëŒ€ë¹„ì €ì ({price_position:.1%})")
            
            # 3. RSI ê³¼ë§¤ë„ í™•ì¸
            if not daily_df.empty:
                daily_df_with_rsi = self.hybrid_strategy.calculate_daily_indicators(daily_df)
                current_rsi = daily_df_with_rsi['rsi'].iloc[-1]
                
                if current_rsi < 30:  # ê³¼ë§¤ë„
                    recovery_score += 2.0
                    reasons.append(f"RSIê³¼ë§¤ë„({current_rsi:.1f})")
                elif current_rsi < 40:
                    recovery_score += 1.0
                    reasons.append(f"RSIë§¤ìˆ˜ê¶Œ({current_rsi:.1f})")
            
            # 4. ë¶„ë´‰ ë°˜ë“± ì‹ í˜¸ í™•ì¸
            minute_df = self.api_client.get_minute_data(symbol, minutes=60)
            if not minute_df.empty and len(minute_df) >= 10:
                # ìµœê·¼ 10ë¶„ê°„ ìƒìŠ¹ ì¶”ì„¸
                recent_prices = minute_df['stck_prpr'].tail(10).tolist()
                rising_count = sum(1 for i in range(1, len(recent_prices)) 
                                 if recent_prices[i] > recent_prices[i-1])
                
                if rising_count >= 6:  # 10ë¶„ ì¤‘ 6ë¶„ ì´ìƒ ìƒìŠ¹
                    recovery_score += 1.5
                    reasons.append(f"ë¶„ë´‰ë°˜ë“±({rising_count}/10)")
                
                # ê±°ë˜ëŸ‰ ì¦ê°€ í™•ì¸
                if len(minute_df) >= 20:
                    recent_vol = minute_df['cntg_vol'].tail(10).mean()
                    past_vol = minute_df['cntg_vol'].head(10).mean()
                    
                    if recent_vol > past_vol * 1.5:  # ìµœê·¼ ê±°ë˜ëŸ‰ 50% ì¦ê°€
                        recovery_score += 1.0
                        reasons.append("ê±°ë˜ëŸ‰ì¦ê°€")
            
            # 5. ì‹œì¥ ìƒí™© ê³ ë ¤ (KOSPI/KOSDAQ ìƒìŠ¹ì‹œ ê°€ì )
            try:
                kospi_data = self.api_client.get_daily_data('000001', days=2)  # KOSPI
                if not kospi_data.empty and len(kospi_data) >= 2:
                    kospi_change = (kospi_data['stck_prpr'].iloc[-1] / kospi_data['stck_prpr'].iloc[-2] - 1) * 100
                    if kospi_change > 0.5:  # KOSPI 0.5% ì´ìƒ ìƒìŠ¹
                        recovery_score += 0.5
                        reasons.append(f"ì‹œì¥ìƒìŠ¹({kospi_change:.1f}%)")
            except:
                pass
            
            # ê²°ë¡  ë„ì¶œ
            should_hold = recovery_score >= 4.0  # 4ì  ì´ìƒì´ë©´ ë³´ìœ 
            strong_recovery = recovery_score >= 6.0  # 6ì  ì´ìƒì´ë©´ ê°•í•œ íšŒë³µ ì‹ í˜¸
            
            reason_text = ', '.join(reasons) if reasons else 'íšŒë³µì‹ í˜¸ì—†ìŒ'
            
            self.logger.info(f"ğŸ“Š {stock_name}({symbol}) íšŒë³µë¶„ì„ ì™„ë£Œ: {recovery_score:.1f}ì  - {reason_text}")
            
            return {
                'should_hold': should_hold,
                'strong_recovery_signal': strong_recovery,
                'recovery_score': recovery_score,
                'reason': reason_text,
                'analysis_details': reasons
            }
            
        except Exception as e:
            self.logger.error(f"íšŒë³µ ê°€ëŠ¥ì„± ë¶„ì„ ì˜¤ë¥˜: {e}")
            return {
                'should_hold': False,
                'strong_recovery_signal': False,
                'recovery_score': 0,
                'reason': f'ë¶„ì„ì˜¤ë¥˜: {e}',
                'analysis_details': []
            }
    
    
    def check_rapid_drop(self, symbol: str, current_price: float) -> Dict:
        """ê°œì„ ëœ ê¸‰ë½ ê°ì§€ ì‹œìŠ¤í…œ - íšŒë³µ ê°€ëŠ¥ì„±ë„ ê³ ë ¤"""
        try:
            minute_df = self.api_client.get_minute_data(symbol, minutes=120)
            
            if minute_df.empty or len(minute_df) < 10:
                return {'should_sell': False, 'reason': 'ë°ì´í„°ë¶€ì¡±'}
            
            # ê¸‰ë½ ê¸°ì¤€ì„ ë” ì—„ê²©í•˜ê²Œ (ì§„ì§œ ìœ„í—˜í•œ ìƒí™©ë§Œ)
            
            # 1ì‹œê°„ ë‚´ 7% ì´ìƒ ê¸‰ë½ (ê¸°ì¡´ 4%ì—ì„œ ìƒí–¥)
            if len(minute_df) >= 60:
                hour_ago_price = minute_df['stck_prpr'].iloc[-60]
                hour_change = (current_price - hour_ago_price) / hour_ago_price
                
                if hour_change < -0.07:  # -7% ì´ìƒ ê¸‰ë½
                    return {'should_sell': True, 'reason': f"ì‹¬ê°í•œê¸‰ë½({hour_change:.1%})"}
            
            # 30ë¶„ ë‚´ ìµœê³ ê°€ ëŒ€ë¹„ 10% ì´ìƒ ê¸‰ë½ (ê¸°ì¡´ 6%ì—ì„œ ìƒí–¥)
            recent_30min = minute_df.tail(30)
            if not recent_30min.empty:
                recent_high = recent_30min['stck_prpr'].max()
                drop_from_high = (current_price - recent_high) / recent_high
                
                if drop_from_high < -0.10:  # -10% ì´ìƒ ê¸‰ë½
                    return {'should_sell': True, 'reason': f"ë‹¨ê¸°í­ë½({drop_from_high:.1%})"}
            
            # ì—°ì† í•˜ë½ë„ ë” ì—„ê²©í•˜ê²Œ
            if len(minute_df) >= 15:
                recent_prices = minute_df['stck_prpr'].tail(15).tolist()
                declining_count = 0
                
                for i in range(1, len(recent_prices)):
                    if recent_prices[i] < recent_prices[i-1]:
                        declining_count += 1
                
                # 15ë¶„ë´‰ ì¤‘ 12ê°œ ì´ìƒì´ í•˜ë½í•˜ê³  -4% ì´ìƒ í•˜ë½
                if declining_count >= 12:
                    total_decline = (recent_prices[-1] - recent_prices[0]) / recent_prices[0]
                    if total_decline < -0.04:
                        return {'should_sell': True, 'reason': f"ì¥ê¸°ì—°ì†í•˜ë½({total_decline:.1%})"}
            
            return {'should_sell': False, 'reason': 'ì •ìƒ'}
            
        except Exception as e:
            return {'should_sell': False, 'reason': f'ì˜¤ë¥˜:{e}'}
