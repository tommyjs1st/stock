    
    def perform_risk_check(self, symbol: str, daily_analysis: Dict, timing_analysis: Dict, 
                          current_price: float) -> Dict:
        """
        ì¢…í•©ì ì¸ ë¦¬ìŠ¤í¬ ì²´í¬
        """
        # 1. ì‹œì¥ ìƒí™© ì²´í¬
        market_risk = self.check_market_conditions()
        
        # 2. ê°œë³„ ì¢…ëª© ë¦¬ìŠ¤í¬
        stock_risk = self.check_individual_stock_risk(symbol, current_price)
        
        # 3. í¬íŠ¸í´ë¦¬ì˜¤ ë¦¬ìŠ¤í¬
        portfolio_risk = self.check_portfolio_risk()
        
        # 4. íƒ€ì´ë° ë¦¬ìŠ¤í¬
        timing_risk = self.check_timing_risk(timing_analysis)
        
        risks = []
        
        if market_risk['risk_level'] > 3:
            risks.append(f"ì‹œì¥ë¦¬ìŠ¤í¬: {market_risk['reason']}")
        
        if stock_risk['risk_level'] > 3:
            risks.append(f"ì¢…ëª©ë¦¬ìŠ¤í¬: {stock_risk['reason']}")
            
        if portfolio_risk['risk_level'] > 3:
            risks.append(f"í¬íŠ¸í´ë¦¬ì˜¤ë¦¬ìŠ¤í¬: {portfolio_risk['reason']}")
            
        if timing_risk['risk_level'] > 3:
            risks.append(f"íƒ€ì´ë°ë¦¬ìŠ¤í¬: {timing_risk['reason']}")
        
        approved = len(risks) == 0
        
        return {
            'approved': approved,
            'reason': '; '.join(risks) if risks else 'ë¦¬ìŠ¤í¬ ì²´í¬ í†µê³¼',
            'risk_count': len(risks)
        }
    
    
    def check_individual_stock_risk(self, symbol: str, current_price: float) -> Dict:
        """
        ê°œë³„ ì¢…ëª© ë¦¬ìŠ¤í¬ ì²´í¬
        """
        risk_level = 0
        reason = ""
        
        try:
            # ìµœê·¼ ê°€ê²© ë³€ë™ì„± ì²´í¬
            df = self.api_client.get_daily_data(symbol, days=30)
            if not df.empty:
                # 30ì¼ ìµœëŒ€ ì¼ì¼ ë³€ë™í­
                daily_changes = df['stck_prpr'].pct_change().abs()
                max_daily_change = daily_changes.max()
                avg_daily_change = daily_changes.mean()
                
                if max_daily_change > 0.15:  # 15% ì´ìƒ ì¼ì¼ ë³€ë™
                    risk_level += 2
                    reason += f"ê³ ë³€ë™ì„±(ìµœëŒ€{max_daily_change:.1%}); "
                    
                if avg_daily_change > 0.05:  # í‰ê·  5% ì´ìƒ ë³€ë™
                    risk_level += 1
                    reason += f"ë†’ì€í‰ê· ë³€ë™ì„±({avg_daily_change:.1%}); "
                
                # ì—°ì† ìƒìŠ¹/í•˜ë½ ì²´í¬
                recent_changes = df['stck_prpr'].pct_change().tail(5)
                consecutive_up = sum(1 for x in recent_changes if x > 0.03)  # 3% ì´ìƒ ìƒìŠ¹
                
                if consecutive_up >= 4:  # 5ì¼ ì¤‘ 4ì¼ ì´ìƒ 3%+ ìƒìŠ¹
                    risk_level += 2
                    reason += "ì—°ì†ê¸‰ë“±ìœ„í—˜; "
            
            # í˜„ì¬ê°€ vs ìµœê·¼ ê³ ì 
            if len(df) >= 20:
                recent_high = df['stck_prpr'].tail(20).max()
                if current_price > recent_high * 0.98:  # ìµœê·¼ ê³ ì  98% ì´ìƒ
                    risk_level += 1
                    reason += "ê³ ì ê·¼ì²˜; "
        
        except Exception as e:
            risk_level = 1
            reason = f"ë°ì´í„°ì¡°íšŒì‹¤íŒ¨: {e}"
        
        return {
            'risk_level': risk_level,
            'reason': reason.rstrip('; ') or 'ì •ìƒ'
        }
    
    
    def check_market_conditions(self) -> Dict:
        """
        ì‹œì¥ ìƒí™© ì²´í¬ - KOSPI/KOSDAQ ê¸‰ë½ ì‹œ ë§¤ìˆ˜ ê¸ˆì§€
        """
        risk_level = 0
        reason = ""
        
        try:
            # KOSPI ì²´í¬
            kospi_data = self.api_client.get_daily_data('000001', days=5)  # KOSPI ì§€ìˆ˜
            if not kospi_data.empty:
                kospi_change = kospi_data['stck_prpr'].pct_change().iloc[-1]
                
                if kospi_change < -0.03:  # 3% ì´ìƒ í•˜ë½
                    risk_level += 2
                    reason += f"KOSPIê¸‰ë½({kospi_change:.1%}); "
                elif kospi_change < -0.015:  # 1.5% ì´ìƒ í•˜ë½
                    risk_level += 1
                    reason += f"KOSPIí•˜ë½({kospi_change:.1%}); "
            
            # ì¶”ê°€ë¡œ VIXë‚˜ ë‹¤ë¥¸ ê³µí¬ì§€ìˆ˜ê°€ ìˆë‹¤ë©´ ì²´í¬
            
        except Exception:
            risk_level = 0
            reason = "ì‹œì¥ë°ì´í„°ì—†ìŒ"
        
        return {
            'risk_level': risk_level,
            'reason': reason.rstrip('; ') or 'ì‹œì¥ìƒí™©ì–‘í˜¸'
        }
    
    
    def calculate_volatility(self, symbol: str) -> float:
        """
        ì¢…ëª©ë³„ ë³€ë™ì„± ê³„ì‚° (20ì¼ ê¸°ì¤€)
        """
        try:
            df = self.api_client.get_daily_data(symbol, days=30)
            if df.empty or len(df) < 20:
                return 0.04  # ê¸°ë³¸ê°’ 4%
            
            # 20ì¼ ì¼ê°„ ìˆ˜ìµë¥ ì˜ í‘œì¤€í¸ì°¨
            daily_returns = df['stck_prpr'].pct_change().dropna()
            volatility = daily_returns.tail(20).std()
            
            return volatility if not pd.isna(volatility) else 0.04
            
        except Exception:
            return 0.04
    
    
    def notify_improved_trade(self, symbol: str, action: str, daily_analysis: Dict, 
                             timing_analysis: Dict, quantity: int, price: float):
        """
        ê°œì„ ëœ ë§¤ë§¤ ì•Œë¦¼
        """
        if not self.notifier:
            return
        
        stock_name = self.get_stock_name(symbol)
        action_emoji = "ğŸ›’" if action == "BUY" else "ğŸ’¸"
        
        title = f"{action_emoji} ê°œì„ ëœ í•˜ì´ë¸Œë¦¬ë“œ {action}!"
        
        # ìœ„í—˜ë„ í‘œì‹œ
        price_position = timing_analysis.get('price_position', 0.5)
        risk_level = "ğŸŸ¢ ì €ìœ„í—˜" if price_position <= 0.4 else "ğŸŸ¡ ì¤‘ìœ„í—˜" if price_position <= 0.7 else "ğŸ”´ ê³ ìœ„í—˜"
        
        message = f"""
    ì¢…ëª©: {stock_name}({symbol})
    ìˆ˜ëŸ‰: {quantity}ì£¼ @ {price:,}ì›
    ì´ì•¡: {quantity * price:,}ì›
    
    ğŸ“Š ë¶„ì„ ê²°ê³¼:
    ìœ„í—˜ë„: {risk_level}
    ê°€ê²©ìœ„ì¹˜: {price_position:.1%} (20ì¼ê³ ì  ëŒ€ë¹„)
    
    ğŸ“… ì¼ë´‰ ë¶„ì„:
    ì‹ í˜¸: {daily_analysis['signal']} (ê°•ë„: {daily_analysis['strength']:.1f})
    ê·¼ê±°: {', '.join(daily_analysis.get('reasons', []))}
    
    â° ë¶„ë´‰ íƒ€ì´ë°:
    ì ìˆ˜: {timing_analysis['timing_score']}/5
    ê·¼ê±°: {', '.join(timing_analysis.get('reasons', []))}
    RSI: {timing_analysis.get('minute_rsi', 0):.1f}
    
    ì‹œê°„: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
    """
        
        color = 0x00ff00 if action == "BUY" else 0xff6600
        self.notifier.send_notification(title, message, color)
