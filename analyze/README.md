# 🚀 주식 매수 신호 분석기

KIS API를 활용하여 시가총액 상위 200개 종목의 기술적 지표를 분석하고 매수 신호를 감지하는 자동화 프로그램입니다.

## 📁 프로젝트 구조

```
├── main.py                    # 메인 실행 파일
├── kis_api_client.py         # KIS API 클라이언트 (토큰 관리, 기본 API 호출)
├── data_fetcher.py           # 데이터 조회 모듈 (주가, 투자자별 매매 데이터)
├── technical_indicators.py   # 기술적 지표 분석 모듈
├── utils.py                  # 유틸리티 모듈 (JSON 처리, 로깅, 메시지 포맷팅)
├── backtest.py              # 백테스트 모듈 (기존)
├── requirements.txt         # 패키지 의존성
├── .env                     # 환경변수 설정 파일
└── README.md               # 프로젝트 설명서
```

## 🔧 설치 및 설정

### 1. 패키지 설치
```bash
pip install -r requirements.txt
```

### 2. 환경변수 설정
`.env` 파일을 생성하고 다음 내용을 입력하세요:

```env
# 필수: KIS API 키
KIS_APP_KEY=your_kis_app_key
KIS_APP_SECRET=your_kis_app_secret

# 선택: Discord 웹훅 URL (결과 전송용)
DISCORD_WEBHOOK_URL=your_discord_webhook_url

# 선택: 상세 모드 (개별 신호별 종목 리스트도 전송)
DETAIL_MODE=false
```

### 3. KIS API 키 발급
1. [한국투자증권 KIS Developers](https://apiportal.koreainvestment.com/) 접속
2. 회원가입 및 API 신청
3. 앱 키(APP KEY)와 앱 시크릿(APP SECRET) 발급

## 🚀 실행 방법

### 메인 분석 실행
```bash
python main.py
```

### 백테스트 실행
```bash
python backtest.py
```

## 📊 분석 기능

### 기술적 지표 (13개)
1. **골든크로스** - 5일선이 20일선 상향 돌파
2. **볼린저밴드 반등** - 하한선 터치 후 반등
3. **MACD 상향돌파** - MACD가 신호선 상향 교차
4. **MACD 골든크로스** - 개선된 MACD 매수 신호
5. **RSI 과매도 회복** - RSI 30 이하에서 35 돌파
6. **스토캐스틱 회복** - %K가 %D 상향 돌파
7. **거래량 급증** - 20일 평균 대비 2배 이상
8. **Williams %R 회복** - 과매도 구간에서 회복
9. **이중바닥 패턴** - 동일 수준 저점 형성 후 상승
10. **일목균형표** - 구름 위 + 전환선>기준선
11. **컵앤핸들 패턴** - 컵 형태 후 고점 근처 회복
12. **외국인 매수추세** - 연속 순매수 패턴
13. **기관 매수추세** - 기관 순매수 우세

### 신호 점수 시스템
- **5점 이상**: 🚀 초강력 매수신호
- **4점**: 🔥 강력 매수신호  
- **3점**: ⭐ 보통 매수신호
- **2점**: ⚡ 약한 매수신호
- **1점**: 💡 단일 매수신호

## 📤 결과 출력

### 1. Discord 메시지 (webhook_url 설정 시)
- 다중신호 종목 우선순위별 알림
- 신호 조합 패턴 분석
- 전체 요약 통계

### 2. 파일 저장
- `backtest_list.json`: 3점 이상 고잠재력 종목 (상위 10개)
- `logs/buying_stocks.log`: 상세 실행 로그

### 3. 콘솔 출력
- 실시간 진행상황
- 분석 결과 요약

## 🔄 모듈별 역할

### `kis_api_client.py`
- KIS API 토큰 관리 (자동 갱신)
- 기본 API 요청 처리
- 재시도 로직 및 에러 처리

### `data_fetcher.py`
- 주가 데이터 조회 (일봉, 실시간)
- 투자자별 매매 데이터 (외국인, 기관)
- 네이버 금융에서 종목 리스트 및 기본 정보

### `technical_indicators.py`
- 13개 기술적 지표 계산
- pandas_ta 모듈 자동 감지 (없으면 수동 계산)
- 매수 신호 종합 점수 계산

### `utils.py`
- JSON 직렬화 (numpy 타입 자동 변환)
- 로깅 설정
- Discord 메시지 포맷팅
- 진행상황 추적

### `main.py`
- 전체 분석 오케스트레이션
- 결과 분류 및 전송
- 에러 처리 및 모니터링

## 🐛 문제 해결

### JSON 직렬화 오류
```
Object of type int64 is not JSON serializable
```
→ `utils.py`의 `convert_numpy_types` 함수가 자동으로 처리합니다.

### pandas_ta 모듈 없음
```
⚠️ pandas_ta 모듈이 없습니다.
```
→ 수동 계산으로 대체되므로 정상 동작합니다. 설치하려면:
```bash
pip install pandas-ta
```

### API 호출 제한
- 종목당 0.5초 간격으로 호출
- 재시도 로직 (최대 3회)
- 토큰 자동 갱신

## 📈 활용 방안

1. **매일 장 마감 후 실행**하여 다음날 매수 후보 발굴
2. **백테스트 결과**와 연계하여 검증된 전략 적용
3. **Discord 알림**으로 실시간 모니터링
4. **점수 기반 포트폴리오** 구성

## ⚠️ 주의사항

- 본 프로그램은 **투자 참고용**이며, 실제 투자 결정은 본인 책임입니다
- **모의투자**로 충분한 검증 후 사용하세요
- API 호출량 제한에 유의하세요
- **위험관리** 원칙을 반드시 준수하세요

## 📝 업데이트 내역

### v2.0.0 (2025-08-18)
- 모듈별 파일 분리로 구조 개선
- JSON 직렬화 문제 해결
- 에러 처리 강화
- 진행상황 추적 기능 추가
- pandas_ta 선택적 사용

### v1.0.0
- 초기 버전 (단일 파일)
- 13개 기술적 지표 분석
- Discord 알림 기능
